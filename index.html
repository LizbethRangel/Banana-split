<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Burger Stack Challenge</title>
    <style>
        :root{
            --stage-width: 360px;
            --stage-height: 620px;
            --bg: #0e0f1a;
            --accent: #ffb347;
            --accent-strong: #ff914d;
            --danger: #ff5c5c;
            --text: #f5f6fa;
            --panel: rgba(17,19,32,0.88);
            --border: rgba(255,255,255,0.06);
        }
        *,*::before,*::after{box-sizing:border-box;}
        html,body{height:100%;margin:0;font-family:"Segoe UI",Roboto,system-ui,sans-serif;background:radial-gradient(circle at 20% 20%,#1f2745 0%,#0b0d18 55%,#05060d 100%);color:var(--text);}
        body{display:flex;align-items:center;justify-content:center;padding:24px;}
        .wrapper{width:100%;max-width:960px;display:grid;gap:24px;grid-template-columns:minmax(0,1fr);}
        header{display:flex;justify-content:space-between;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 24px;backdrop-filter:blur(12px);box-shadow:0 24px 60px rgba(0,0,0,0.35);}
        .heading{display:flex;flex-direction:column;gap:4px;}
        .heading h1{margin:0;font-size:1.7rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--accent);}
        .heading span{font-size:0.95rem;color:rgba(245,246,250,0.75);letter-spacing:0.04em;}
        .scoreboard{display:flex;align-items:center;gap:20px;font-size:1.05rem;}
        .scoreboard span.value{font-weight:700;color:var(--accent);font-size:1.3rem;}
        .height-meter{display:flex;align-items:center;gap:10px;color:rgba(245,246,250,0.7);font-size:0.9rem;}
        .meter{position:relative;width:18px;height:140px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.06);overflow:hidden;box-shadow:inset 0 4px 12px rgba(0,0,0,0.35);}
        .meter-fill{position:absolute;left:3px;right:3px;bottom:3px;height:0;background:linear-gradient(180deg,#ffdf8c 0%,#ffb347 45%,#ff914d 100%);border-radius:8px;transition:height 0.25s ease;}
        main{display:flex;justify-content:center;}
        .stage-wrapper{position:relative;padding:20px 24px;background:var(--panel);border-radius:20px;border:1px solid var(--border);box-shadow:0 40px 80px rgba(0,0,0,0.4);}
    .stage{position:relative;width:var(--stage-width);min-height:var(--stage-height);height:auto;background:linear-gradient(180deg,#12142a 0%,#0c0e1d 55%,#080910 100%);border-radius:24px;border:1px solid rgba(255,255,255,0.04);overflow:hidden;box-shadow:inset 0 18px 40px rgba(0,0,0,0.45);} 
    .stage::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at 50% 120%,rgba(255,207,129,0.05) 0%,rgba(255,145,77,0.08) 30%,rgba(8,9,16,0.92) 70%);pointer-events:none;} 
        .stack{position:absolute;bottom:0;left:0;right:0;z-index:3;height:100%;pointer-events:none;}
        .layer{position:absolute;height:32px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,0.35);transition:left 0.1s linear,width 0.12s ease;}
        .layer::before{content:"";position:absolute;inset:0;border-radius:12px;opacity:0.6;mix-blend-mode:overlay;}
        .layer.moving{outline:2px dashed rgba(255,255,255,0.1);outline-offset:-3px;}
        .layer.fell{animation:fall-out 0.6s forwards ease-in;}
        @keyframes fall-out{to{transform:translateY(260px) rotate(35deg);opacity:0;}}
        .layer.crowned{box-shadow:0 0 0 3px rgba(255,214,160,0.35),0 18px 32px rgba(0,0,0,0.45);}
        .high-score-panel{display:flex;flex-direction:column;gap:12px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 24px;box-shadow:0 20px 40px rgba(0,0,0,0.28);} 
        .high-score-panel h2{margin:0;font-size:1.2rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--accent);} 
        .high-score-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;} 
        .high-score-list li{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border-radius:10px;padding:8px 12px;font-size:0.95rem;} 
        .high-score-list li .rank{font-weight:600;color:var(--accent);} 
        .high-score-list li .name{flex:1;margin:0 8px;} 
        .high-score-list li .value{font-weight:600;color:rgba(245,246,250,0.9);} 
        .high-score-list li.empty{justify-content:center;color:rgba(245,246,250,0.6);font-style:italic;} 
    .bun-bottom{background-color:transparent;background-repeat:no-repeat,no-repeat;background-size:100% 100%,100% 100%;background-position:center,center;} 
    .bun-bottom::before{display:none;} 
    .bun-top{background-color:transparent;border-radius:12px;background-repeat:no-repeat;background-position:center;background-size:100% 100%;} 
    .bun-top::before{display:none;} 
    .patty{background-color:transparent;border-radius:12px;background-repeat:no-repeat;background-position:center;background-size:100% 100%;} 
        .beef{background-color:transparent;border-radius:12px;background-repeat:no-repeat,no-repeat;background-position:center,center;background-size:100% 100%,100% 100%;} 
    .layer.beef::before,.layer.lettuce::before,.layer.patty::before,.layer.bun-top::before{display:none;} 
    .lettuce{background-color:transparent;border-radius:12px;background-repeat:no-repeat,no-repeat;background-position:center,center;background-size:100% 100%,100% 100%;} 
    .tomato{background-color:transparent;border-radius:12px;background-repeat:no-repeat,no-repeat;background-position:center,center;background-size:100% 100%,100% 100%;} 
    .tomato::before{display:none;} 
    .onion{background-color:transparent;border-radius:12px;background-repeat:no-repeat;background-position:center;background-size:100% 100%;} 
    .onion::before{display:none;} 
    .plate{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:280px;height:64px;padding:6px 12px 10px 12px;background:radial-gradient(circle at 50% 35%,rgba(255,255,255,0.34) 0%,rgba(255,255,255,0.05) 42%,rgba(94,108,132,0.2) 75%,rgba(27,33,47,0.28) 90%),linear-gradient(180deg,#e3e8f3 0%,#c4ccdc 40%,#a2adbf 70%,#848fa2 100%);border-radius:52% 52% 44% 44%;border:1px solid rgba(255,255,255,0.25);box-shadow:0 22px 46px rgba(0,0,0,0.48),inset 0 4px 12px rgba(255,255,255,0.2),inset 0 -8px 18px rgba(49,54,72,0.35);z-index:2;overflow:hidden;}
    .plate::before{content:"";position:absolute;inset:8px 16px 14px 16px;border-radius:50% 50% 46% 46%;background:linear-gradient(180deg,rgba(255,255,255,0.88) 0%,rgba(219,226,240,0.86) 30%,rgba(182,194,214,0.8) 60%,rgba(133,143,160,0.65) 100%);box-shadow:inset 0 8px 12px rgba(255,255,255,0.55),inset 0 -6px 16px rgba(58,64,84,0.35);}
    .plate::after{content:"";position:absolute;inset:18px 38px 24px 38px;border-radius:50% 50% 48% 48%;background:radial-gradient(circle at 50% 24%,rgba(255,255,255,0.75) 0%,rgba(255,255,255,0.22) 40%,rgba(255,255,255,0) 65%),radial-gradient(circle at 50% 140%,rgba(55,63,81,0.45) 0%,rgba(55,63,81,0.08) 50%,rgba(55,63,81,0) 80%),repeating-radial-gradient(circle at 50% 50%,rgba(255,255,255,0.18) 0,rgba(255,255,255,0.18) 2px,rgba(255,255,255,0) 2px,rgba(255,255,255,0) 4px);opacity:0.9;mix-blend-mode:screen;}
        .counterlighting{position:absolute;bottom:0;left:0;right:0;height:100px;background:radial-gradient(circle at 50% 80%,rgba(255,186,117,0.25) 0%,rgba(8,9,16,0) 70%);pointer-events:none;z-index:1;}
        .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(8,9,16,0.72) 0%,rgba(8,9,16,0.92) 100%);display:flex;align-items:center;justify-content:center;padding:24px;z-index:90;}
        .overlay.hidden{display:none;}
        .overlay-card{max-width:440px;width:100%;background:rgba(17,19,32,0.95);border-radius:20px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 40px 80px rgba(0,0,0,0.45);padding:36px;text-align:center;display:flex;flex-direction:column;gap:18px;}
        .overlay-card h2{margin:0;font-size:1.8rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--accent);}
        .overlay-card p{margin:0;font-size:1rem;line-height:1.6;color:rgba(245,246,250,0.9);} 
    .overlay-card label{display:flex;flex-direction:column;gap:6px;text-align:left;font-size:0.9rem;color:rgba(245,246,250,0.85);} 
    .overlay-card input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.16);background:rgba(8,9,16,0.65);color:var(--text);font-size:1rem;font-family:inherit;transition:border-color 0.2s ease,box-shadow 0.2s ease;} 
    .overlay-card input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,145,77,0.25);} 
    .overlay-card input[type="text"][aria-invalid="true"]{border-color:var(--danger);} 
        .btn{align-self:center;background:var(--accent);color:#2b1b0b;border:none;padding:12px 28px;border-radius:999px;font-weight:700;font-size:1.02rem;cursor:pointer;letter-spacing:0.08em;text-transform:uppercase;box-shadow:0 18px 28px rgba(255,145,77,0.35);transition:transform 0.2s ease,box-shadow 0.2s ease;} 
        .btn:hover{transform:translateY(-2px);box-shadow:0 22px 40px rgba(255,145,77,0.45);} 
        .game-grid{display:grid;grid-template-columns:1fr;gap:24px;width:100%;justify-items:center;}
        .game-grid.two-player{grid-template-columns:1fr 1fr;max-width:1200px;}
        .player-score-box{display:flex;flex-direction:column;align-items:center;background:rgba(255,255,255,0.05);padding:8px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);}
        .player-score-box .label{font-size:0.8rem;color:rgba(245,246,250,0.6);text-transform:uppercase;letter-spacing:0.05em;}
        .player-score-box .value{font-size:1.4rem;font-weight:700;color:var(--accent);}
        .controls-hint{margin-top:12px;font-size:0.9rem;color:rgba(245,246,250,0.5);text-align:center;}
        .mode-select{display:flex;gap:12px;justify-content:center;margin-bottom:16px;}
        .mode-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:var(--text);padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.2s ease;}
        .mode-btn.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:bold;}
        @media(max-width:900px){.game-grid.two-player{grid-template-columns:1fr;}}
    </style>
</head>
<body>
    <div class="wrapper">
        <header>
            <div class="heading">
                <h1>Burger Stack</h1>
                <span>Stack ingredients as high as you can without toppling the burger.</span>
            </div>
            <div class="scoreboard" aria-live="polite">
                <div id="sp-score-container" style="display:flex; gap:20px; align-items:center;">
                    <div>Layers: <span class="value" id="scoreValue">0</span></div>
                    <div>Best: <span class="value" id="bestValue">0</span></div>
                    <div class="height-meter">
                        <span>Progress</span>
                        <div class="meter" id="heightMeter" role="meter">
                            <div class="meter-fill"></div>
                        </div>
                    </div>
                </div>
                <div id="mp-score-container" style="display:none; gap:24px;">
                    <div class="player-score-box">
                        <span class="label">Player 1</span>
                        <span class="value" id="score-p1">0</span>
                    </div>
                    <div class="player-score-box">
                        <span class="label">Player 2</span>
                        <span class="value" id="score-p2">0</span>
                    </div>
                </div>
            </div>
        </header>
        <section class="high-score-panel" id="highScorePanel" aria-label="High scores">
            <h2>High Scores</h2>
            <ol class="high-score-list" id="highScoreList"></ol>
        </section>
        <main>
            <div class="game-grid" id="gameGrid">
                <div class="stage-wrapper" id="p1-wrapper">
                    <div class="stage" id="stage-p1">
                        <div class="stack" id="stack-p1"></div>
                        <div class="plate" aria-hidden="true"></div>
                        <div class="counterlighting" aria-hidden="true"></div>
                    </div>
                    <div class="controls-hint" id="hint-p1" style="display:none">Controls: SPACE or Click</div>
                </div>
                <div class="stage-wrapper" id="p2-wrapper" style="display:none">
                    <div class="stage" id="stage-p2">
                        <div class="stack" id="stack-p2"></div>
                        <div class="plate" aria-hidden="true"></div>
                        <div class="counterlighting" aria-hidden="true"></div>
                    </div>
                    <div class="controls-hint">Controls: ENTER</div>
                </div>
            </div>
        </main>
    </div>

    <div class="overlay" id="overlay">
        <div class="overlay-card">
            <h2 id="overlayTitle">Burger Stack Challenge</h2>
            <p id="overlayMessage">Drop each ingredient so it lands on the one below it. Keep building forever—your run only ends when the burger falls.</p>
            
            <div class="mode-select">
                <button class="mode-btn active" id="btn-1p" type="button">1 Player</button>
                <button class="mode-btn" id="btn-2p" type="button">2 Players</button>
            </div>

            <label for="playerNameInput" id="nameInputLabel">
                Player Name
                <input type="text" id="playerNameInput" name="playerName" placeholder="Enter your name" autocomplete="name" maxlength="24">
            </label>
            <button class="btn" id="overlayButton" type="button">Start stacking</button>
        </div>
    </div>

    <script>
    (() => {
        const STAGE_WIDTH = 360;
        const STAGE_HEIGHT = 620;
        const LAYER_HEIGHT = 32;
        const PLATE_HEIGHT = 56;
        const MOVE_BASE_SPEED = 3.2;
        const MIN_OVERLAP = 4;
        const STAGE_PADDING = 180;
        const HIGH_SCORES_KEY = 'burgerStackHighScores';
        const LAST_PLAYER_KEY = 'burgerStackLastPlayer';
        const MAX_HIGH_SCORES_DISPLAY = 10;

        const INGREDIENT_TYPES = ['patty','beef','lettuce','tomato','onion'];
        const PATTY_PRIMARY = 'Food/Good Patty.png';
        const BEEF_PRIMARY = 'Food/Good Patty.png';
        const BEEF_FALLBACK = 'beef.png';
        const LETTUCE_PRIMARY = 'Food/Good lettuce.png';
        const LETTUCE_FALLBACK = 'Food/Lettuce.png';
        const TOMATO_PRIMARY = 'Food/Tomatoo.png';
        const TOMATO_FALLBACK = 'linear-gradient(180deg,#ff675d 0%,#e5383b 60%,#b41323 100%)';
        const ONION_IMAGE = 'Food/Onionn.png';
        const BUN_TOP_PRIMARY = 'Food/Top Bunn.png';
        const BUN_BOTTOM_PRIMARY = 'Food/Bottom bunn.png';
        const BUN_BOTTOM_FALLBACK = 'linear-gradient(180deg,#f8c889 0%,#eaa24f 60%,#d9782b 100%)';

        function buildBackgroundImage(...sources){
            return sources
                .filter(Boolean)
                .map(src => src.startsWith('url(') || src.includes('gradient(')
                    ? src
                    : `url("${src.replace(/"/g, '\"')}")`)
                .join(', ');
        }

        class BurgerGame {
            constructor(config) {
                this.stageEl = document.getElementById(config.stageId);
                this.stackEl = document.getElementById(config.stackId);
                this.scoreEl = document.getElementById(config.scoreId);
                this.onGameOver = config.onGameOver;
                this.onScoreUpdate = config.onScoreUpdate;
                
                this.layers = [];
                this.movingLayer = null;
                this.running = false;
                this.score = 0;
                this.speed = MOVE_BASE_SPEED;
                this.maxStackHeight = PLATE_HEIGHT + LAYER_HEIGHT;
                this.animationId = null;
                this.lastTime = 0;
                this.direction = 1;
                
                this.update = this.update.bind(this);
            }

            createLayerElement(width, bottom, left, type){
                const el = document.createElement('div');
                el.className = `layer ${type}`;
                el.style.width = `${width}px`;
                el.style.left = `${left}px`;
                el.style.bottom = `${bottom}px`;
                if(type === 'bun-top'){
                    el.style.backgroundImage = buildBackgroundImage(BUN_TOP_PRIMARY);
                } else if(type === 'patty'){
                    el.style.backgroundImage = buildBackgroundImage(PATTY_PRIMARY);
                } else if(type === 'lettuce'){
                    el.style.backgroundImage = buildBackgroundImage(LETTUCE_PRIMARY, LETTUCE_FALLBACK);
                } else if(type === 'beef'){
                    el.style.backgroundImage = buildBackgroundImage(BEEF_PRIMARY, BEEF_FALLBACK);
                } else if(type === 'tomato'){
                    el.style.backgroundImage = buildBackgroundImage(TOMATO_PRIMARY, TOMATO_FALLBACK);
                } else if(type === 'onion'){
                    el.style.backgroundImage = buildBackgroundImage(ONION_IMAGE);
                }
                return el;
            }

            reset(){
                this.stackEl.innerHTML = '';
                this.layers = [];
                this.maxStackHeight = PLATE_HEIGHT + LAYER_HEIGHT;
                this.stageEl.style.height = `${STAGE_HEIGHT}px`;
                this.score = 0;
                this.speed = MOVE_BASE_SPEED;
                if(this.scoreEl) this.scoreEl.textContent = '0';
            }

            spawnBase(){
                const width = 240;
                const left = (STAGE_WIDTH - width) / 2;
                const bottom = PLATE_HEIGHT;
                const baseEl = this.createLayerElement(width, bottom, left, 'bun-bottom');
                baseEl.style.backgroundImage = buildBackgroundImage(BUN_BOTTOM_PRIMARY, BUN_BOTTOM_FALLBACK);
                this.stackEl.appendChild(baseEl);
                this.layers.push({el: baseEl, width, left, bottom, type: 'bun-bottom'});
                this.updateStageHeight(bottom + LAYER_HEIGHT);
            }

            pickIngredient(){
                if(this.score >= 4 && Math.random() > 0.82){
                    return 'bun-top';
                }
                const index = Math.floor(Math.random() * INGREDIENT_TYPES.length);
                return INGREDIENT_TYPES[index];
            }

            spawnMovingLayer(){
                const prev = this.layers[this.layers.length - 1];
                const width = prev.width;
                const bottom = prev.bottom + LAYER_HEIGHT;
                const startLeft = Math.random() < 0.5 ? 0 : STAGE_WIDTH - width;
                const type = this.pickIngredient();
                const el = this.createLayerElement(width, bottom, startLeft, type);
                el.classList.add('moving');
                this.stackEl.appendChild(el);
                this.movingLayer = {el, width, left: startLeft, bottom, type, direction: startLeft === 0 ? 1 : -1};
            }

            dropCurrentLayer(){
                if(!this.running || !this.movingLayer) return;
                const prev = this.layers[this.layers.length - 1];
                const current = this.movingLayer;
                this.movingLayer = null;

                const prevLeft = prev.left;
                const prevRight = prev.left + prev.width;
                const curLeft = current.left;
                const curRight = current.left + current.width;

                const overlapLeft = Math.max(prevLeft, curLeft);
                const overlapRight = Math.min(prevRight, curRight);
                const overlapWidth = overlapRight - overlapLeft;

                if(overlapWidth <= MIN_OVERLAP){
                    current.el.classList.remove('moving');
                    current.el.classList.add('fell');
                    this.endGame();
                    return;
                }

                current.width = overlapWidth;
                current.left = overlapLeft;
                current.el.style.width = `${overlapWidth}px`;
                current.el.style.left = `${overlapLeft}px`;
                current.el.classList.remove('moving');
                this.layers.push(current);

                this.score = this.layers.length - 1;
                this.speed = Math.min(7.5, MOVE_BASE_SPEED + this.score * 0.18);
                this.updateStageHeight(current.bottom + LAYER_HEIGHT);
                
                if(this.scoreEl) this.scoreEl.textContent = this.score;
                if(this.onScoreUpdate) this.onScoreUpdate(this.score);

                setTimeout(() => this.spawnMovingLayer(), 260);
            }

            updateStageHeight(topHeight){
                this.maxStackHeight = Math.max(this.maxStackHeight, topHeight);
                const desiredHeight = Math.max(STAGE_HEIGHT, this.maxStackHeight + STAGE_PADDING);
                this.stageEl.style.height = `${desiredHeight}px`;
            }

            update(time){
                if(!this.running) return;
                this.animationId = requestAnimationFrame(this.update);
                const dt = (time - this.lastTime) / 1000 || 0;
                this.lastTime = time;

                if(this.movingLayer){
                    let newLeft = this.movingLayer.left + this.movingLayer.direction * this.speed * dt * 100;
                    const minLeft = 0;
                    const maxLeft = STAGE_WIDTH - this.movingLayer.width;
                    if(newLeft <= minLeft){
                        newLeft = minLeft;
                        this.movingLayer.direction = 1;
                    } else if(newLeft >= maxLeft){
                        newLeft = maxLeft;
                        this.movingLayer.direction = -1;
                    }
                    this.movingLayer.left = newLeft;
                    this.movingLayer.el.style.left = `${newLeft}px`;
                }
            }

            start(){
                this.reset();
                this.running = true;
                this.spawnBase();
                this.spawnMovingLayer();
                this.lastTime = performance.now();
                this.animationId = requestAnimationFrame(this.update);
            }

            endGame(){
                this.running = false;
                cancelAnimationFrame(this.animationId);
                if(this.onGameOver) this.onGameOver(this.score);
            }
        }

        // --- Game Manager & UI ---
        
        const overlay = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlayTitle');
        const overlayMessage = document.getElementById('overlayMessage');
        const overlayButton = document.getElementById('overlayButton');
        const playerNameInput = document.getElementById('playerNameInput');
        const btn1P = document.getElementById('btn-1p');
        const btn2P = document.getElementById('btn-2p');
        
        const spScoreContainer = document.getElementById('sp-score-container');
        const mpScoreContainer = document.getElementById('mp-score-container');
        const p2Wrapper = document.getElementById('p2-wrapper');
        const gameGrid = document.getElementById('gameGrid');
        const hintP1 = document.getElementById('hint-p1');
        
        const bestEl = document.getElementById('bestValue');
        const heightMeter = document.getElementById('heightMeter');
        const heightFill = heightMeter.querySelector('.meter-fill');
        const highScoreList = document.getElementById('highScoreList');

        let isTwoPlayer = false;
        let game1, game2;
        let highScores = loadHighScores();
        let bestScore = getHighestScore();
        let currentPlayer = localStorage.getItem(LAST_PLAYER_KEY) || '';

        if(playerNameInput) playerNameInput.value = currentPlayer;
        renderHighScores();
        updateBestScoreDisplay();

        // Initialize Games
        game1 = new BurgerGame({
            stageId: 'stage-p1',
            stackId: 'stack-p1',
            scoreId: 'scoreValue', // Default to SP score
            onGameOver: (score) => handleGameOver(1, score),
            onScoreUpdate: (score) => handleScoreUpdate(1, score)
        });

        game2 = new BurgerGame({
            stageId: 'stage-p2',
            stackId: 'stack-p2',
            scoreId: 'score-p2',
            onGameOver: (score) => handleGameOver(2, score),
            onScoreUpdate: (score) => handleScoreUpdate(2, score)
        });

        // Mode Switching
        btn1P.addEventListener('click', () => setMode(false));
        btn2P.addEventListener('click', () => setMode(true));

        function setMode(twoPlayer){
            isTwoPlayer = twoPlayer;
            if(isTwoPlayer){
                btn1P.classList.remove('active');
                btn2P.classList.add('active');
                spScoreContainer.style.display = 'none';
                mpScoreContainer.style.display = 'flex';
                p2Wrapper.style.display = 'block';
                gameGrid.classList.add('two-player');
                hintP1.style.display = 'block';
                
                // Rebind P1 score to MP box
                game1.scoreEl = document.getElementById('score-p1');
            } else {
                btn1P.classList.add('active');
                btn2P.classList.remove('active');
                spScoreContainer.style.display = 'flex';
                mpScoreContainer.style.display = 'none';
                p2Wrapper.style.display = 'none';
                gameGrid.classList.remove('two-player');
                hintP1.style.display = 'none';
                
                // Rebind P1 score to SP box
                game1.scoreEl = document.getElementById('scoreValue');
            }
        }

        function handleScoreUpdate(playerNum, score){
            if(!isTwoPlayer && playerNum === 1){
                // Update progress bar for SP
                const reference = Math.max(bestScore, score, 1);
                const percent = Math.min(100, Math.round((score / reference) * 100));
                heightMeter.setAttribute('aria-valuemax', String(reference));
                heightMeter.setAttribute('aria-valuenow', String(score));
                heightFill.style.height = `${percent}%`;
                bestEl.textContent = Math.max(bestScore, score);
            }
        }

        function handleGameOver(playerNum, score){
            if(isTwoPlayer){
                if(!game1.running && !game2.running){
                    showGameOver(`Game Over!`, `P1: ${game1.score} - P2: ${game2.score}`);
                }
            } else {
                recordPlayerScore(currentPlayer, score);
                showGameOver('Burger toppled!', `You stacked <strong>${score}</strong> layers.`);
            }
        }

        function showGameOver(title, message){
            overlayTitle.textContent = title;
            overlayMessage.innerHTML = message;
            overlayButton.textContent = 'Play again';
            overlay.classList.remove('hidden');
        }

        function startGame(){
            overlay.classList.add('hidden');
            game1.start();
            if(isTwoPlayer) game2.start();
        }

        // Input Handling
        overlayButton.addEventListener('click', () => {
            const name = playerNameInput ? playerNameInput.value.trim() : '';
            if(!name && !isTwoPlayer){
                if(playerNameInput){
                    playerNameInput.setAttribute('aria-invalid', 'true');
                    playerNameInput.focus();
                }
                return;
            }
            currentPlayer = name;
            localStorage.setItem(LAST_PLAYER_KEY, currentPlayer);
            if(playerNameInput) playerNameInput.removeAttribute('aria-invalid');
            startGame();
        });

        if(playerNameInput){
            playerNameInput.addEventListener('input', () => {
                if(playerNameInput.value.trim()){
                    playerNameInput.removeAttribute('aria-invalid');
                }
            });
        }

        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space'){
                e.preventDefault();
                if(overlay.classList.contains('hidden')){
                    game1.dropCurrentLayer();
                } else {
                    // Optional: Start game with Space
                }
            }
            if(e.code === 'Enter'){
                e.preventDefault();
                if(overlay.classList.contains('hidden')){
                    if(isTwoPlayer) game2.dropCurrentLayer();
                    else game1.dropCurrentLayer(); // Allow Enter for SP too?
                } else {
                    overlayButton.click();
                }
            }
        });
        
        // Touch/Click handling
        document.getElementById('stage-p1').addEventListener('pointerdown', (e) => {
            if(game1.running) {
                e.preventDefault();
                game1.dropCurrentLayer();
            }
        });
        
        document.getElementById('stage-p2').addEventListener('pointerdown', (e) => {
            if(isTwoPlayer && game2.running) {
                e.preventDefault();
                game2.dropCurrentLayer();
            }
        });

        function loadHighScores(){
            try {
                const raw = localStorage.getItem(HIGH_SCORES_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch(e){ return []; }
        }
        function saveHighScores(){
            localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(highScores));
        }
        function getHighestScore(){
            return highScores.reduce((max, entry) => Math.max(max, Number(entry.score) || 0), 0);
        }
        function renderHighScores(){
            if(!highScoreList) return;
            highScoreList.innerHTML = '';
            if(!highScores.length){
                const emptyItem = document.createElement('li');
                emptyItem.className = 'empty';
                emptyItem.textContent = 'No scores yet. Be the first to set a record!';
                highScoreList.appendChild(emptyItem);
                return;
            }
            const entries = highScores.slice(0, MAX_HIGH_SCORES_DISPLAY);
            entries.forEach((entry, index) => {
                const li = document.createElement('li');
                const rank = document.createElement('span');
                rank.className = 'rank';
                rank.textContent = `${index + 1}.`;
                const nameSpan = document.createElement('span');
                nameSpan.className = 'name';
                nameSpan.textContent = entry.name;
                const value = document.createElement('span');
                value.className = 'value';
                value.textContent = String(entry.score);
                li.append(rank, nameSpan, value);
                highScoreList.appendChild(li);
            });
        }
        function updateBestScoreDisplay(){
            if(bestEl) bestEl.textContent = bestScore;
        }
        function recordPlayerScore(name, finalScore){
            const trimmed = (name || '').trim();
            if(!trimmed || finalScore <= 0) return;

            const existing = highScores.find(entry => entry.name === trimmed);
            const timestamp = Date.now();
            if(existing){
                if(finalScore > existing.score){
                    existing.score = finalScore;
                    existing.updatedAt = timestamp;
                }
            } else {
                highScores.push({name: trimmed, score: finalScore, updatedAt: timestamp});
            }

            highScores = highScores
                .filter(entry => typeof entry.score === 'number' && entry.score >= 0)
                .sort((a,b) => b.score - a.score || a.updatedAt - b.updatedAt);

            saveHighScores();
            bestScore = getHighestScore();
            updateBestScoreDisplay();
            renderHighScores();
        }

        overlayTitle.textContent = 'Burger Stack Challenge';
        overlayMessage.innerHTML = 'Drop each ingredient so it lands on the one below it.<br>Keep building forever—your run only ends when the burger falls.<br>Scroll to follow the top of your burger.<br><br><strong>Press Space / Tap to drop.</strong>';
        overlayButton.textContent = 'Start stacking';
    })();
    </script>
</body>
</html>
